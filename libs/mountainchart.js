!function(e){function t(i){if(a[i])return a[i].exports;var n=a[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var a={};t.m=e,t.c=a,t.i=function(e){return e},t.d=function(e,a,i){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=9)}([function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),a(6);var i=a(1),n=function(e){return e&&e.__esModule?e:{default:e}}(i);a(2);var o={version:"1.0.17",build:1505427616553},r=Vizabi.Tool.extend("MountainChart",{init:function(e,t){this.name="mountainchart",this.components=[{component:n.default,placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","locale","data","ui"]},{component:Vizabi.Component.get("timeslider"),placeholder:".vzb-tool-timeslider",model:["state.time","state.entities","state.marker","ui"]},{component:Vizabi.Component.get("dialogs"),placeholder:".vzb-tool-dialogs",model:["state","ui","locale"]},{component:Vizabi.Component.get("buttonlist"),placeholder:".vzb-tool-buttonlist",model:["state","ui","locale"]},{component:Vizabi.Component.get("treemenu"),placeholder:".vzb-tool-treemenu",model:["state.marker","state.marker_tags","state.time","locale"]},{component:Vizabi.Component.get("datawarning"),placeholder:".vzb-tool-datawarning",model:["locale"]},{component:Vizabi.Component.get("datanotes"),placeholder:".vzb-tool-datanotes",model:["state.marker","locale"]},{component:Vizabi.Component.get("steppedspeedslider"),placeholder:".vzb-tool-stepped-speed-slider",model:["state.time","locale"]}],this._super(e,t)},default_model:{state:{time:{delay:100,delayThresholdX2:50,delayThresholdX4:25},entities:{opacitySelectDim:.3,opacityRegular:.7}},locale:{},ui:{chart:{manualSortingEnabled:!0,yMaxMethod:"latest",showProbeX:!0,probeX:1.85,xLogStops:[1,2,5],xPoints:50,preload:"income_mountains",preloadKey:"world"},buttons:["colors","find","stack","show","moreoptions","fullscreen","presentation"],dialogs:{popup:["colors","find","stack","show","moreoptions"],sidebar:["colors","find","stack"],moreoptions:["opacity","speed","stack","axesmc","colors","presentation","about"]},datawarning:{doubtDomain:[],doubtRange:[]},presentation:!1}},versionInfo:o});t.default=r},function(e,t,a){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}Object.defineProperty(t,"__esModule",{value:!0});var o=a(3),r=i(o),s=a(5),l=i(s),c=a(4),h=i(c),d=Vizabi,m=d.utils,u=(d._globals,d.iconset),g=u.warn,p=u.question,v=d.helpers,f=v.svgexport,x=v["d3.axisWithLabelPicker"],b=v["d3.dynamicBackground"],y=Vizabi.Component.extend("mountainchart",{init:function(e,t){var i=this;this.name="mountainchart",this.template=a(8),this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"locale",type:"locale"},{name:"data",type:"data"},{name:"ui",type:"ui"}],this.model_binds={"change:time.value":function(e){i._readyOnce&&i.model.marker.getFrame(i.model.time.value,i.frameChanged.bind(i))},"change:time.playing":function(e){i.model.time.playing||i.redrawDataPoints()},"change:marker.axis_x.xScaleFactor":function(){i.ready()},"change:marker.axis_x.xScaleShift":function(){i.ready()},"change:marker.axis_x.tailFatX":function(){i.ready()},"change:marker.axis_x.tailCutX":function(){i.ready()},"change:marker.axis_x.tailFade":function(){i.ready()},"change:ui.chart.probeX":function(){i.ready()},"change:ui.chart.showProbeX":function(){i.ready()},"change:ui.chart.xPoints":function(){i.ready()},"change:ui.chart.xLogStops":function(){i.updateSize()},"change:ui.chart.yMaxMethod":function(){i._adjustMaxY({force:!0}),i.redrawDataPoints()},"change:time.record":function(e){i.model.time.record?i._export.open(this.element,this.name):i._export.reset()},"change:marker.highlight":function(e){i._readyOnce&&(i.highlightMarkers(),i.updateOpacity())},"change:marker.select":function(e){i._readyOnce&&(i.selectMarkers(),i._selectlist.redraw(),i.updateOpacity(),i.updateDoubtOpacity(),i.redrawDataPoints(),i._probe.redraw())},"change:marker.opacitySelectDim":function(e){i.updateOpacity()},"change:marker.opacityRegular":function(e){i.updateOpacity()},"change:marker":function(e,t){i._readyOnce&&(t.indexOf("scaleType")>-1?i.ready():(t.indexOf("zoomedMin")>-1||t.indexOf("zoomedMax")>-1)&&(i.zoomToMaxMin(),i.redrawDataPoints(),i._probe.redraw()))},"change:marker.group":function(e,t){i._readyOnce&&(t.indexOf("group.merge")>-1||i.ready())},"change:marker.group.merge":function(e){i._readyOnce&&(i.updatePointers(),i.redrawDataPoints())},"change:marker.stack":function(e){i._readyOnce&&i.ready()},"change:marker.stack.which":function(e){i._readyOnce&&i.model.time.playing&&i.model.time.pause()},"change:marker.stack.use":function(e){i._readyOnce&&i.model.time.playing&&i.model.time.pause()},"change:marker.color.palette":function(e){i._readyOnce&&(i.redrawDataPointsOnlyColors(),i._selectlist.redraw())}},this._super(e,t),this._math=new r.default(this),this._export=new f(this),this._export.prefix("vzb-mc-").deleteClasses(["vzb-mc-mountains-mergestacked","vzb-mc-mountains-mergegrouped","vzb-mc-mountains","vzb-mc-year","vzb-mc-mountains-labels","vzb-mc-axis-labels"]),this._probe=new h.default(this),this._selectlist=new l.default(this),this.area=d3.area().curve(d3.curveBasis).x(function(e){return i.xScale(i._math.rescale(e.x))}).y0(function(e){return i.yScale(e.y0)}).y1(function(e){return i.yScale(e.y0+e.y)}),this.stack=d3.stack().order(d3.stackOrderReverse).value(function(e,t){return i.cached[t][e].y}),this.xScale=null,this.yScale=null,this.cScale=null,this.xAxis=x("bottom"),this.rangeRatio=1,this.rangeShift=0,this.cached={},this.mesh=[],this.yMax=0},domReady:function(){var e=this;this.element=d3.select(this.element),this.graph=this.element.select(".vzb-mc-graph"),this.xAxisEl=this.graph.select(".vzb-mc-axis-x"),this.xTitleEl=this.graph.select(".vzb-mc-axis-x-title"),this.yTitleEl=this.graph.select(".vzb-mc-axis-y-title"),this.infoEl=this.graph.select(".vzb-mc-axis-info"),this.dataWarningEl=this.graph.select(".vzb-data-warning"),this.yearEl=this.graph.select(".vzb-mc-year"),this.year=new b(this.yearEl),this.mountainMergeStackedContainer=this.graph.select(".vzb-mc-mountains-mergestacked"),this.mountainMergeGroupedContainer=this.graph.select(".vzb-mc-mountains-mergegrouped"),this.mountainAtomicContainer=this.graph.select(".vzb-mc-mountains"),this.mountainLabelContainer=this.graph.select(".vzb-mc-mountains-labels"),this.tooltip=this.element.select(".vzb-mc-tooltip"),this.eventAreaEl=this.element.select(".vzb-mc-eventarea"),this.probeEl=this.element.select(".vzb-mc-probe"),this.probeLineEl=this.probeEl.select("line"),this.probeTextEl=this.probeEl.selectAll("text"),this.element.onTap(function(t,a){e._interact()._mouseout(t,a)})},afterPreload:function(){var e=this;if(this._math.xScaleFactor=this.model.marker.axis_x.xScaleFactor,this._math.xScaleShift=this.model.marker.axis_x.xScaleShift,this.precomputedShape&&this.precomputedShape[0]&&this.precomputedShape[0].income_mountains){var t=this.precomputedShape[0].income_mountains["yMax_"+this.model.ui.chart.yMaxMethod],a=this.precomputedShape[0].income_mountains.shape;t&&a&&0!==a.length&&(this.xScale=d3.scaleLog().domain([this.model.marker.axis_x.domainMin,this.model.marker.axis_x.domainMax]),this.yScale=d3.scaleLinear().domain([0,Math.round(t)]),e.updateSize(a.length),e.zoomToMaxMin(),a=a.map(function(t,a){return{x:e.mesh[a],y0:0,y:+t}}),this.mountainAtomicContainer.selectAll(".vzb-mc-prerender").data([0]).enter().append("path").attr("class","vzb-mc-prerender").style("fill","pink").style("opacity",0).attr("d",e.area(a)).transition().duration(1e3).ease(d3.easeLinear).style("opacity",1))}},readyOnce:function(){this.eventAreaEl.on("mousemove",function(){e.model.time.dragging||e.model.ui.chart.showProbeX&&e._probe.redraw({level:e.xScale.invert(d3.mouse(this)[0]),full:!0})}).on("mouseout",function(){e.model.time.dragging||e.model.ui.chart.showProbeX&&e._probe.redraw()});var e=this;this.on("resize",function(){e.updateSize()||(e.updatePointers(),e.redrawDataPoints(),e._selectlist.redraw(),e._probe.redraw())}),this.KEY=this.model.entities.getDimension(),this.TIMEDIM=this.model.time.getDimension(),this.mountainAtomicContainer.select(".vzb-mc-prerender").remove(),this.year.setText(this.model.time.formatDate(this.model.time.value)),this.wScale=d3.scaleLinear().domain(this.model.ui.datawarning.doubtDomain).range(this.model.ui.datawarning.doubtRange)},ready:function(){var e=this;this._math.xScaleFactor=this.model.marker.axis_x.xScaleFactor,this._math.xScaleShift=this.model.marker.axis_x.xScaleShift,this.updateUIStrings(),this.updateIndicators(),this.model.marker.getFrame(this.model.time.value,function(t){t&&(e.values=t,e.model.marker.getFrame(e.model.time.end,e.updateEntities.bind(e)),e.updateSize(),e.zoomToMaxMin(),e._spawnMasks(),e.updateTime(),e.updatePointers(),e._adjustMaxY({force:!0}),e.redrawDataPoints(),e.redrawDataPointsOnlyColors(),e.highlightMarkers(),e.selectMarkers(),e._selectlist.redraw(),e.updateOpacity(),e.updateDoubtOpacity(),e._probe.redraw())})},frameChanged:function(e,t){if(!e)return m.warn("change:time.value: empty data received from marker.getFrame(). doing nothing");t.toString()==this.model.time.value.toString()&&(this.values=e,this.updateTime(),this.updatePointers(),this.redrawDataPoints(),this._selectlist.redraw(),this._probe.redraw(),this.updateDoubtOpacity())},updateSize:function(e){var t={small:{margin:{top:10,right:10,left:10,bottom:18},infoElHeight:16},medium:{margin:{top:20,right:20,left:20,bottom:30},infoElHeight:20},large:{margin:{top:30,right:30,left:30,bottom:35},infoElHeight:22}},a={medium:{margin:{top:20,right:20,left:20,bottom:50},infoElHeight:26},large:{margin:{top:30,right:30,left:30,bottom:50},infoElHeight:32}};this.activeProfile=this.getActiveProfile(t,a);var i=this.activeProfile.margin,n=this.activeProfile.infoElHeight;this.height=parseInt(this.element.style("height"),10)-i.top-i.bottom||0,this.width=parseInt(this.element.style("width"),10)-i.left-i.right||0,(this.height<=0||this.width<=0)&&(this.height=0,this.width=0,m.warn("Mountain chart updateSize(): vizabi container is too little or has display:none")),this.graph.attr("transform","translate("+i.left+","+i.top+")");var o=this.model.locale.isRTL(),r={topOffset:"large"===this.getLayoutProfile()?2*i.top:0,xAlign:"large"===this.getLayoutProfile()?o?"left":"right":"center",yAlign:"large"===this.getLayoutProfile()?"top":"center",widthRatio:"large"===this.getLayoutProfile()?3/8:.8};this.year.setConditions(r).resize(this.width,this.height),this.yScale.range([this.height,0]),this.xScale.range([this.rangeShift,this.width*this.rangeRatio+this.rangeShift]);var s=this._readyOnce?this.model.marker.axis_x.scaleType:"log";this.xAxis.scale(this.xScale).tickSizeOuter(0).tickPadding(9).tickSizeMinor(3,0).labelerOptions({scaleType:s,toolMargin:i,pivotingLimit:1.5*i.bottom,method:this.xAxis.METHOD_REPEATING,stops:this._readyOnce?this.model.ui.chart.xLogStops:[1],formatter:this.model.marker.axis_x.getTickFormatter()}),this.xAxisEl.attr("transform","translate(0,"+this.height+")").call(this.xAxis),this.xTitleEl.select("text").attr("transform","translate("+this.width+","+this.height+")").attr("dy","-0.36em"),this.yTitleEl.style("font-size",n+"px").attr("transform","translate("+(o?this.width:0)+","+i.top+")");var l=this.dataWarningEl.select("text").node().getBBox();if(this.dataWarningEl.select("svg").attr("width",l.height).attr("height",l.height).attr("x",.1*l.height).attr("y",1*-l.height+1),this.dataWarningEl.attr("transform","translate("+(o?this.width-l.width-2*l.height:0)+","+(i.top+1.5*l.height)+")").select("text").attr("dx",1.5*l.height),this.infoEl.select("svg").node()){var c=this.yTitleEl.node().getBBox(),h=m.transform(this.yTitleEl.node()),d=o?c.x+h.translateX-1.4*n:c.x+h.translateX+c.width+.4*n;this.infoEl.select("svg").attr("width",n+"px").attr("height",n+"px"),this.infoEl.attr("transform","translate("+d+","+(h.translateY-.8*n)+")")}this.eventAreaEl.attr("y",this.height).attr("width",this.width).attr("height",i.bottom),e||(e=this.model.ui.chart.xPoints),this.mesh=this._math.generateMesh(e,s,this.xScale.domain())},zoomToMaxMin:function(){var e=this.model.marker.axis_x;if(!(null==e.zoomedMin&&null==e.domainMin||null==e.zoomedMax&&null==e.domainMin)){var t=this.xScale(e.zoomedMin||e.domainMin),a=this.xScale(e.zoomedMax||e.domainMax);isFinite(t)&&isFinite(a)&&t!==a&&(this.rangeRatio=this.width/(a-t)*this.rangeRatio,this.rangeShift=(this.rangeShift-t)/(a-t)*this.width,this.xScale.range([this.rangeShift,this.width*this.rangeRatio+this.rangeShift]),this.xAxisEl.call(this.xAxis))}},updateUIStrings:function(){var e=this;this.translator=this.model.locale.getTFunction();this.model.marker.axis_x.getConceptprops();this.xTitleEl.select("text").text(this.translator("unit/mountainchart_hardcoded_income_per_day")),this.yTitleEl.select("text").text(this.translator("mount/title")),m.setIcon(this.dataWarningEl,g).select("svg").attr("width","0px").attr("height","0px"),this.dataWarningEl.append("text").text(this.translator("hints/dataWarning")),m.setIcon(this.infoEl,p).select("svg").attr("width","0px").attr("height","0px"),this.infoEl.on("click",function(){e.parent.findChildByName("gapminder-datanotes").pin()}),this.infoEl.on("mouseover",function(){var t=this.getBBox(),a=m.makeAbsoluteContext(this,this.farthestViewportElement)(t.x-10,t.y+t.height+10),i=e.root.element.getBoundingClientRect(),n=e.element.node().getBoundingClientRect();e.parent.findChildByName("gapminder-datanotes").setHook("axis_y").show().setPos(a.x+n.left-i.left,a.y)}),this.infoEl.on("mouseout",function(){e.parent.findChildByName("gapminder-datanotes").hide()}),this.dataWarningEl.on("click",function(){e.parent.findChildByName("gapminder-datawarning").toggle()}).on("mouseover",function(){e.updateDoubtOpacity(1)}).on("mouseout",function(){e.updateDoubtOpacity()})},updateDoubtOpacity:function(e){null==e&&(e=this.wScale(+this.time.getUTCFullYear().toString())),this.someSelected&&(e=1),this.dataWarningEl.style("opacity",e)},updateIndicators:function(){var e=this;this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.cScale=this.model.marker.color.getScale(),this.xAxis.tickFormat(e.model.marker.axis_x.getTickFormatter())},updateEntities:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.values,t=this;this.mountainPointers=this.model.marker.getKeys().filter(function(a){return e.axis_x[a[t.KEY]]&&e.axis_y[a[t.KEY]]&&e.axis_s[a[t.KEY]]}).map(function(a){var i={};return i[t.KEY]=a[t.KEY],i.KEY=function(){return this[t.KEY]},i.sortValue=[e.axis_y[i.KEY()]||0,0],i.aggrLevel=0,i}),this.groupedPointers=d3.nest().key(function(a){return"property"===t.model.marker.stack.use?e.stack[a.KEY()]:e.group[a.KEY()]}).sortValues(function(e,t){return t.sortValue[0]-e.sortValue[0]}).entries(this.mountainPointers);var a=this.model.marker.group.manualSorting,i=m.isArray(a)&&a.length>1;this.groupedPointers.forEach(function(e){var n=i?a.includes(e.key)?a.length-1-a.indexOf(e.key):-1:d3.sum(e.values.map(function(e){return e.sortValue[0]}));e.values.forEach(function(e){e.sortValue[1]=n}),e[t.model.entities.getDimension()]=e.key,e.KEY=function(){return this.key},e.aggrLevel=1});var n={};t.groupedPointers.forEach(function(e){n[e.key]=e.values[0].sortValue[1]}),"none"===t.model.marker.stack.which?(this.stackedPointers=[],this.mountainPointers.sort(function(e,t){return t.sortValue[0]-e.sortValue[0]})):(this.stackedPointers=d3.nest().key(function(t){return e.stack[t.KEY()]}).key(function(t){return e.group[t.KEY()]}).sortKeys(function(e,t){return n[t]-n[e]}).sortValues(function(e,t){return t.sortValue[0]-e.sortValue[0]}).entries(this.mountainPointers),this.mountainPointers.sort(function(e,t){return t.sortValue[1]-e.sortValue[1]}),this.stackedPointers.forEach(function(e){e.KEY=function(){return this.key},e[t.model.entities.getDimension()]=e.key,e.aggrLevel=2})),this.mountainsMergeStacked=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain.vzb-mc-aggrlevel2").data(this.stackedPointers),this.mountainsMergeGrouped=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain.vzb-mc-aggrlevel1").data(this.groupedPointers),this.mountainsAtomic=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain.vzb-mc-aggrlevel0").data(this.mountainPointers),this.mountainsMergeStacked.exit().remove(),this.mountainsMergeGrouped.exit().remove(),this.mountainsAtomic.exit().remove(),this.mountainsMergeStacked=this.mountainsMergeStacked.enter().append("path").attr("class","vzb-mc-mountain vzb-mc-aggrlevel2").merge(this.mountainsMergeStacked),this.mountainsMergeGrouped=this.mountainsMergeGrouped.enter().append("path").attr("class","vzb-mc-mountain vzb-mc-aggrlevel1").merge(this.mountainsMergeGrouped),this.mountainsAtomic=this.mountainsAtomic.enter().append("path").attr("class","vzb-mc-mountain vzb-mc-aggrlevel0").merge(this.mountainsAtomic),this.mountains=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain"),this.mountains.on("mousemove",function(e,a){m.isTouchDevice()||t._interact()._mousemove(e,a)}).on("mouseout",function(e,a){m.isTouchDevice()||t._interact()._mouseout(e,a)}).on("click",function(e,a){m.isTouchDevice()||(t._interact()._click(e,a),t.highlightMarkers())}).onTap(function(e,a){t._interact()._click(e,a),d3.event.stopPropagation()}).onLongTap(function(e,t){})},_interact:function(){var e=this;return{_mousemove:function(t,a){if(!e.model.time.dragging&&!e.model.time.playing){e.model.marker.highlightMarker(t);d3.mouse(e.graph.node()).map(function(e){return parseInt(e)});e._setTooltip(t.key?e.model.marker.color.getColorlegendMarker().label.getItems()[t.key]:e.values.label[t.KEY()]),e._selectlist.showCloseCross(t,!0)}},_mouseout:function(t,a){e.model.time.dragging||e.model.time.playing||(e._setTooltip(""),e.model.marker.clearHighlighted(),e._selectlist.showCloseCross(t,!1))},_click:function(t){(e.model.time.dragging||e.model.time.playing)&&!e.model.marker.isSelected(t)||e.model.marker.selectMarker(t)}}},highlightMarkers:function(){var e=this;this.someHighlighted=this.model.marker.highlight.length>0,this.selectList&&this.someSelected&&this.selectList.classed("vzb-highlight",function(t){return e.model.marker.isHighlighted(t)})},selectMarkers:function(){this.someSelected=this.model.marker.select.length>0,this._selectlist.rebuild(),this.nonSelectedOpacityZero=!1},_sumLeafPointersByMarker:function(e,t){var a=this;return e.key?d3.sum(e.values.map(function(e){return a._sumLeafPointersByMarker(e,t)})):a.values[t][e.KEY()]},updateOpacity:function(){var e=this,t=this.model.marker.opacityRegular,a=this.model.marker.opacitySelectDim;this.mountains.style("opacity",function(i){return e.someHighlighted&&e.model.marker.isHighlighted(i)?1:e.someSelected?e.model.marker.isSelected(i)?1:a:e.someHighlighted?.3:t}),this.mountains.classed("vzb-selected",function(t){return e.model.marker.isSelected(t)});var i=e.model.marker.opacitySelectDim<.01;i!==this.nonSelectedOpacityZero&&this.mountainsAtomic.style("pointer-events",function(t){return e.someSelected&&i&&!e.model.marker.isSelected(t)?"none":"visible"}),this.nonSelectedOpacityZero=e.model.marker.opacitySelectDim<.01},updateTime:function(){this.time_1=null==this.time?this.model.time.value:this.time,this.time=this.model.time.value,this.duration=this.model.time.playing&&this.time-this.time_1>0?this.model.time.delayAnimations:0,this.year.setText(this.model.time.formatDate(this.time),this.duration)},updatePointers:function(){var e=this;this.yMax=0,this.mountainPointers.forEach(function(t,a){var i=e._spawn(e.values,t);e.cached[t.KEY()]=i,t.hidden=0===i.length}),"none"!==e.model.marker.stack.which&&this.stackedPointers.forEach(function(t){var a=[];t.values.forEach(function(e){a=a.concat(e.values.filter(function(e){return!e.hidden}))}),e.stack.keys(a.map(function(e){return e.KEY()}))(d3.range(e.mesh.length)).forEach(function(t,i){var n=a[i].KEY();t.forEach(function(t,a){e.cached[n][a].y0=t[0]})})}),this.mountainPointers.forEach(function(t){t.yMax=d3.max(e.cached[t.KEY()].map(function(e){return e.y0+e.y})),e.yMax<t.yMax&&(e.yMax=t.yMax)});var t=e.model.marker.group.merge,a=e.model.marker.stack.merge;this.stackedPointers.forEach(function(t){var a=e._getFirstLastPointersInStack(t);e.cached[t.key]=e._getVerticesOfaMergedShape(a),e.values.color[t.key]="_default",e.values.axis_y[t.key]=e._sumLeafPointersByMarker(t,"axis_y"),t.yMax=a.first.yMax}),this.groupedPointers.forEach(function(t){var a=e._getFirstLastPointersInStack(t);e.cached[t.key]=e._getVerticesOfaMergedShape(a),e.values.color[t.key]=e.values.color[a.first.KEY()],e.values.axis_y[t.key]=e._sumLeafPointersByMarker(t,"axis_y"),t.yMax=a.first.yMax}),a||t||"property"!==this.model.marker.stack.use||this.groupedPointers.forEach(function(e){var t=e.values.filter(function(e){return!e.hidden});e.yMax=t[0].yMax,e.values.forEach(function(t){t.yMaxGroup=e.yMax})})},_getFirstLastPointersInStack:function(e){var t=void 0,a=void 0,i=void 0,n=void 0;return e.values[0].values?(t=e.values[0].values.filter(function(e){return!e.hidden}),a=e.values[e.values.length-1].values.filter(function(e){return!e.hidden}),i=t[0],n=a[a.length-1]):(t=e.values.filter(function(e){return!e.hidden}),i=t[0],n=t[t.length-1]),(!t.length||a&&!a.length)&&m.warn("mountain chart failed to generate shapes. check the incoming data"),{first:i,last:n}},_getVerticesOfaMergedShape:function(e){var t=this,a=e.first.KEY(),i=e.last.KEY();return t.mesh.map(function(e,n){var o=t.cached[a][n].y0+t.cached[a][n].y-t.cached[i][n].y0;return{x:e,y0:t.cached[i][n].y0,y:o}})},_spawnMasks:function(){var e=this,t=this._math.unscale(this.model.marker.axis_x.tailFatX),a=this._math.unscale(this.model.marker.axis_x.tailCutX),i=this.model.marker.axis_x.tailFade,n=2*Math.PI/(Math.log(t)-Math.log(a)),o=Math.PI-Math.log(t)*n;this.spawnMask=[],this.cosineShape=[],this.cosineArea=0,this.mesh.forEach(function(r,s){e.spawnMask[s]=r<a?1:r>7*i?0:Math.exp((a-r)/i),e.cosineShape[s]=r>a&&r<t?1+Math.cos(Math.log(r)*n+o):0,e.cosineArea+=e.cosineShape[s]})},_spawn:function(e,t){var a=this,i=e.axis_y[t.KEY()],n=a._math.giniToSigma(e.axis_s[t.KEY()]),o=a._math.gdpToMu(e.axis_x[t.KEY()],n);if(!i||!o||!n)return[];var r=[],s=0;return this.mesh.forEach(function(e,t){r[t]=a._math.pdf.lognormal(e,o,n),s+=a.spawnMask[t]*r[t]}),this.mesh.map(function(e,t){return{x:e,y0:0,y:i*(r[t]*(1-a.spawnMask[t])+a.cosineShape[t]/a.cosineArea*s)}})},_adjustMaxY:function(e){e||(e={});var t=this,a=this.model.ui.chart.yMaxMethod;if("immediate"===a||e.force)if("latest"===a){var i=t.values;t.model.marker.getFrame(t.model.time.end,function(e){e&&(t.values=e,t.updatePointers(),t.values=i,t.yScale.domain([0,Math.round(t.yMax)]),t.updatePointers(),t.redrawDataPoints())})}else t.yMax||m.warn("Setting yMax to "+t.yMax+". You failed again :-/"),t.yScale.domain([0,Math.round(t.yMax)])},redrawDataPoints:function(){var e=this,t=this.model.marker.group.merge,a=this.model.marker.stack.merge,i=this.model.marker.stack.which,n=(this.model.time.dragging||this.model.time.playing)&&"none"!==i;this._adjustMaxY(),this.mountainsMergeStacked.each(function(t){var i=d3.select(this),n=!a;e._renderShape(i,t.KEY(),n)}),this.mountainsMergeGrouped.each(function(i){var o=d3.select(this),r=!t&&!n||a&&!e.model.marker.isSelected(i);e._renderShape(o,i.KEY(),r)}),this.mountainsAtomic.each(function(i,o){var r=d3.select(this),s=i.hidden||(t||a||n)&&!e.model.marker.isSelected(i);e._renderShape(r,i.KEY(),s)}),"none"===i?this.mountainsAtomic.sort(function(e,t){return t.yMax-e.yMax}):"all"===i||t||n||this.mountainsAtomic.sort(function(e,t){return t.yMaxGroup-e.yMaxGroup})},redrawDataPointsOnlyColors:function(){var e=this;if(!this.mountains)return m.warn("redrawDataPointsOnlyColors(): no mountains  defined. likely a premature call, fix it!");var t="indicator"===this.model.marker.color.use;this.mountains.style("fill",function(a){return e.values.color[a.KEY()]?t&&"_default"==e.values.color[a.KEY()]?e.model.marker.color.palette._default:e.cScale(e.values.color[a.KEY()]):"#d3d3d3"})},_renderShape:function(e,t,a){var i=this.model.marker.stack.which,n=this;if(e.classed("vzb-hidden",a),a)return void("none"!==i&&e.style("stroke-opacity",0));var o={};o[this.KEY]=t,this.model.marker.isSelected(o)?e.attr("d",this.area(this.cached[t].filter(function(e){return e.y>.001*n.values.axis_y[t]}))):e.attr("d",this.area(this.cached[t])),"indicator"===this.model.marker.color.use&&e.style("fill",n.values.color[t]?"_default"!==n.values.color[t]?n.cScale(n.values.color[t]):n.model.marker.color.palette._default:"#d3d3d3"),"none"!==i&&e.transition().duration(900*Math.random()+100).ease(d3.easeCircle).style("stroke-opacity",.5),this.model.time.record&&this._export.write({type:"path",id:t,time:this.model.time.value.getUTCFullYear(),fill:this.cScale(this.values.color[t]),d:this.area(this.cached[t])})},_setTooltip:function(e){if(e){var t=d3.mouse(this.graph.node()).map(function(e){return parseInt(e)});this.tooltip.classed("vzb-hidden",!1).attr("transform","translate("+t[0]+","+t[1]+")").selectAll("text").attr("text-anchor","middle").attr("alignment-baseline","middle").text(e);var a=this.tooltip.select("text").node().getBBox();this.tooltip.select("rect").attr("width",a.width+8).attr("height",a.height+8).attr("x",-a.width-25).attr("y",-a.height-25).attr("rx",.2*a.height).attr("ry",.2*a.height),this.tooltip.selectAll("text").attr("x",-a.width-25+(a.width+8)/2).attr("y",-a.height-25+(a.height+11)/2);var i=t[0]-a.width-25>0?t[0]:a.width+25,n=t[1]-a.height-25>0?t[1]:a.height+25;this.tooltip.attr("transform","translate("+i+","+n+")")}else this.tooltip.classed("vzb-hidden",!0)},preload:function(){var e,t=this,a=this,i=m.getProp(this,["model","ui","chart","preload"]),o=m.getProp(this,["model","ui","chart","preloadKey"]);if(!i)return Promise.resolve();var r=this.model.entities.dim,s=this.model.time.dim,l={language:this.model.locale.id,from:"datapoints",select:{key:[r,s],value:[i]},where:{$and:[n({},r,"$"+r),n({},s,"$"+s)]},join:(e={},n(e,"$"+r,{key:r,where:n({},r,{$in:[o||"world"]})}),n(e,"$"+s,{key:s,where:n({},s,this.model.time.formatDate(this.model.time.value))}),e),order_by:[s]};return new Promise(function(e,o){t.model.data.load(l,n({},i,function(e){return JSON.parse(e)})).then(function(t){a.precomputedShape=a.model.data.getData(t),e()},function(e){return m.warn("Problem with Preload mountainchart query: ",e,JSON.stringify(l))})})}});t.default=y},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=Vizabi.Component.get("_dialog").extend("axesmc",{init:function(e,t){this.name="axesmc";var i=this;this.model_binds={"change:ui.chart.xLogStops":function(){i.updateView()},"change:ui.chart.yMaxMethod":function(){i.updateView()}},this.components=[{component:Vizabi.Component.get("minmaxinputs"),placeholder:".vzb-xlimits-container",model:["state.marker","state.time","locale"],markerID:"axis_x",ui:{selectDomainMinMax:!1,selectZoomedMinMax:!0}}],this._super(e,t),this.template=a(7)},readyOnce:function(){this._super();var e=this;this.yMaxRadio=this.element.select(".vzb-yaxis-container").selectAll("input").on("change",function(){e.setModel("yMaxMethod",d3.select(this).node().value)}),this.xLogStops=this.element.select(".vzb-xaxis-container").selectAll("input").on("change",function(){e.setModel("xLogStops",d3.select(this).node().value)}),this.probeCheck=this.element.select(".vzb-probe-check").on("change",function(){e.setModel("showProbeX",d3.select(this).property("checked"))}),this.probeFieldEl=this.element.select(".vzb-probe-field").on("change",function(){var t=parseFloat(this.value.replace(",","."));if(!t||t<=e.model.state.marker.axis_x.tailCutX)return void(this.value=e.model.ui.chart.probeX);t>e.model.state.marker.axis_x.domainMax&&(t=e.model.state.marker.axis_x.domainMax),this.value=t,e.setModel("probeX",t)}),this.updateView()},updateView:function(){var e=this;this.yMaxRadio.property("checked",function(){return d3.select(this).node().value===e.model.ui.chart.yMaxMethod}),this.xLogStops.property("checked",function(){return-1!==e.model.ui.chart.xLogStops.indexOf(+d3.select(this).node().value)}),this.probeCheck.property("checked",this.model.ui.chart.showProbeX),this.probeFieldEl.property("value",this.model.ui.chart.probeX)},setModel:function(e,t){var a=void 0;"yMaxMethod"==e&&(a=t),"xLogStops"==e&&(a=[],this.xLogStops.each(function(){d3.select(this).property("checked")&&a.push(+d3.select(this).node().value)})),"probeX"!=e&&"showProbeX"!=e||(a=t),this.model.ui.chart[e]=a}});t.default=i},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=Vizabi,n=(i.utils,Vizabi.Class.extend({init:function(e){this.context=e,this.xScaleFactor=1,this.xScaleShift=0},rescale:function(e){return Math.exp(this.xScaleFactor*Math.log(e)+this.xScaleShift)},unscale:function(e){return Math.exp((Math.log(e)-this.xScaleShift)/this.xScaleFactor)},generateMesh:function(e,t,a){var i="linear"===t?a[0]:Math.log(this.unscale(a[0])),n="linear"===t?a[1]:Math.log(this.unscale(a[1])),o=(n-i)/e,r=d3.range(i,n,o).concat(n);return r="linear"!==t?r.map(function(e){return Math.exp(e)}):r.filter(function(e){return e>0})},gdpToMu:function(e,t,a,i){return Math.log(e/365)-t*t/2},giniToSigma:function(e){return this.normsinv((e/100+1)/2)*Math.pow(2,.5)},pdf:{normal:function(e,t,a){return Math.exp(-.5*Math.log(2*Math.PI)-Math.log(a)-Math.pow(e-t,2)/(2*a*a))},lognormal:function(e,t,a){return Math.exp(-.5*Math.log(2*Math.PI)-Math.log(a)-Math.pow(Math.log(e)-t,2)/(2*a*a))}},normsinv:function(e){var t=[-39.69683028665376,220.9460984245205,-275.9285104469687,138.357751867269,-30.66479806614716,2.506628277459239],a=[-54.47609879822406,161.5858368580409,-155.6989798598866,66.80131188771972,-13.28068155288572],i=[-.007784894002430293,-.3223964580411365,-2.400758277161838,-2.549732539343734,4.374664141464968,2.938163982698783],n=[.007784695709041462,.3224671290700398,2.445134137142996,3.754408661907416];if(e<.02425){var o=Math.sqrt(-2*Math.log(e));return(((((i[0]*o+i[1])*o+i[2])*o+i[3])*o+i[4])*o+i[5])/((((n[0]*o+n[1])*o+n[2])*o+n[3])*o+1)}if(.97575<e){var r=Math.sqrt(-2*Math.log(1-e));return-(((((i[0]*r+i[1])*r+i[2])*r+i[3])*r+i[4])*r+i[5])/((((n[0]*r+n[1])*r+n[2])*r+n[3])*r+1)}var s=e-.5,l=s*s;return(((((t[0]*l+t[1])*l+t[2])*l+t[3])*l+t[4])*l+t[5])*s/(((((a[0]*l+a[1])*l+a[2])*l+a[3])*l+a[4])*l+1)}}));t.default=n},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=Vizabi.Class.extend({init:function(e){this.context=e},redraw:function(e){var t=this.context;if(e||(e={}),e.level||(e.level=t.model.ui.chart.probeX),t.probeEl.classed("vzb-hidden",!e.level||!t.model.ui.chart.showProbeX),e.level){t.xAxisEl.call(t.xAxis.highlightValue(e.full?e.level:"none"));var a=0,i=0,n=0,o=function(o){a+=t.values.axis_y[o.KEY()],t.cached[o.KEY()].forEach(function(a){i+=a.y,t._math.rescale(a.x)<e.level&&(n+=a.y)})};"all"===t.model.marker.stack.which?t.stackedPointers.forEach(o):"none"===t.model.marker.stack.which?t.mountainPointers.forEach(o):t.groupedPointers.forEach(o);var r=d3.format(".3r"),s=t.model.marker.axis_y.getTickFormatter();t.heightOfLabels=t.heightOfLabels||.66*t.height,t.probeTextEl.each(function(a,i){if(8===i){var n=d3.select(this);e.full||t.model.ui.chart.probeX!=t.model.marker.axis_x.tailFatX?n.classed("vzb-hidden",!0):(n.text(t.translator("mount/extremepoverty")).classed("vzb-hidden",!1).attr("x",-t.height).attr("y",t.xScale(e.level)).attr("dy","-1.15em").attr("dx","0.5em").attr("transform","rotate(-90)"),t.heightOfLabels=t.height-n.node().getBBox().width-1.75*n.node().getBBox().height)}}),t.probeTextEl.each(function(o,l){if(8!==l){var c=d3.select(this),h=void 0;0!==l&&4!==l||(h=r(n/i*100)+"%"),1!==l&&5!==l||(h=r(100-n/i*100)+"%"),2!==l&&6!==l||(h=s(a*n/i)),3!==l&&7!==l||(h=s(a*(1-n/i))+" "+t.translator("mount/people")),c.text(h).classed("vzb-hidden",!e.full&&(t.someSelected||0!==l&&4!==l)).attr("x",t.xScale(e.level)+([0,4,2,6].indexOf(l)>-1?-6:5)).attr("y",t.heightOfLabels).attr("dy",[0,1,4,5].indexOf(l)>-1?0:"1.5em")}}),t.probeLineEl.attr("x1",t.xScale(e.level)).attr("x2",t.xScale(e.level)).attr("y1",t.height+6).attr("y2",0)}}});t.default=i},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=Vizabi,n=i.utils,o=i.iconset.close,r=Vizabi.Class.extend({init:function(e){this.context=e},rebuild:function(e){var t=this.context,a=this,i=t.mountainPointers.concat(t.groupedPointers).concat(t.stackedPointers).filter(function(e){return t.model.marker.isSelected(e)}).sort(function(e,t){return e.sortValue&&t.sortValue?e.sortValue[1]===t.sortValue[1]?d3.descending(e.sortValue[0],t.sortValue[0]):d3.descending(e.sortValue[1],t.sortValue[1]):e.aggrLevel!=t.aggrLevel?d3.descending(e.aggrLevel,t.aggrLevel):e.aggrLevel&&t.aggrLevel?d3.descending(e.yMax,t.yMax):0});t.selectList=t.mountainLabelContainer.selectAll("g.vzb-mc-label").data(n.unique(i,function(e){return e.KEY()})),t.selectList.exit().remove(),t.selectList=t.selectList.enter().append("g").attr("class","vzb-mc-label").each(function(e,a){var i=d3.select(this);i.append("circle").attr("class","vzb-mc-label-legend"),i.append("text").attr("class","vzb-mc-label-shadow vzb-mc-label-text"),i.append("text").attr("class","vzb-mc-label-text"),i.append("g").attr("class","vzb-mc-label-x vzb-label-shadow vzb-invisible").on("click",function(e,a){n.isTouchDevice()||(d3.event.stopPropagation(),t.model.marker.clearHighlighted(),t.model.marker.selectMarker(e),d3.event.stopPropagation())}).onTap(function(e,a){d3.select("#"+e.geo+"-label-"+t._id).remove(),t.model.marker.clearHighlighted(),t.model.marker.selectMarker(e)});var r=i.select("g.vzb-mc-label-x");n.isTouchDevice()?(r.append("rect"),r.append("text").attr("class","vzb-mc-label-x-text").text("Deselect")):(n.setIcon(r,o).select("svg").attr("class","vzb-mc-label-x-icon").attr("width","0px").attr("height","0px"),r.insert("circle","svg"))}).on("mousemove",function(e,i){n.isTouchDevice()||(a.showCloseCross(e,!0),t.model.marker.highlightMarker(e))}).on("mouseout",function(e,i){n.isTouchDevice()||(a.showCloseCross(e,!1),t.model.marker.clearHighlighted())}).on("click",function(e,a){n.isTouchDevice()||(t.model.marker.clearHighlighted(),t.model.marker.selectMarker(e))}).merge(t.selectList)},redraw:function(){var e=this.context;if(e.selectList&&e.someSelected){var t=e.mountainLabelContainer.append("g").attr("class","vzb-mc-label").append("text").text("0"),a=1.2*t.node().getBBox().height,i=parseFloat(t.style("font-size"))/a;d3.select(t.node().parentNode).remove();var o=e.model.marker.axis_y.getTickFormatter(),r=e.yTitleEl.select("text").node().getBBox().height||0,s=(e.height-3*r)/(e.selectList.data().length+2);a>s&&(a=s);var l="null",c=0,h=e.model.marker.color.getColorlegendMarker().label.getItems(),d=e.model.locale.isRTL();e.selectList.attr("transform",function(t,i){t.aggrLevel!=l&&(c+=a);var n=a*i+2*r+c;return l=t.aggrLevel,"translate("+(d?e.width:0)+","+n+")"}).each(function(t,r){var l=d3.select(this).attr("id",t.geo+"-label-"+e._id),c="";c=t.key?"all"===t.key?e.translator("mount/merging/world"):h[t.key]:e.values.label[t.KEY()];var m=e.values.axis_y[t.KEY()],u=c+": "+o(m)+(0===r?" "+e.translator("mount/people"):""),g=l.selectAll(".vzb-mc-label-text").attr("x",(d?-1:1)*a).attr("y",a).text(u).style("font-size",a===s?a*i+"px":null),p=g.node().getBBox(),v=l.select(".vzb-mc-label-x");if(n.isTouchDevice()){var f=v.select("text").node().getBBox();v.classed("vzb-revert-color",!0).select(".vzb-mc-label-x-text").classed("vzb-revert-color",!0).attr("x",p.width+1.12*p.height+.5*f.width).attr("y",.55*p.height),v.select("rect").attr("width",f.width+.6*p.height).attr("height",p.height).attr("x",p.width+.9*p.height).attr("y",0).attr("rx",.25*p.height).attr("ry",.25*p.height)}else v.attr("x",p.width+1.1*p.height).attr("y",p.height/3),v.select("circle").attr("r",.4*p.height).attr("cx",(d?-1:1)*(p.width+1.1*p.height)).attr("cy",p.height/3),v.select("svg").attr("x",(d?-1:1)*(p.width+p.height*(1.1-(d?-.4:.4)))).attr("y",p.height*(1/3-.4)).attr("width",.8*p.height).attr("height",.8*p.height);l.select(".vzb-mc-label-legend").attr("r",a/3).attr("cx",(d?-1:1)*a*.4).attr("cy",a/1.5).style("fill",e.cScale(e.values.color[t.KEY()])),l.onTap(function(t,a){d3.event.stopPropagation(),e.model.marker.highlightMarker(t),setTimeout(function(){e.model.marker.unhighlightMarker(t)},2e3)})})}},showCloseCross:function(e,t){var a=this.context,i=a.KEY;a.selectList.filter(function(t){return t[i]==e[i]}).select(".vzb-mc-label-x").classed("vzb-invisible",!t)}});t.default=r},function(e,t){},function(e,t){e.exports='<div class=\'vzb-dialog-modal\'>\n    <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="axesmc" data-click="pinDialog"></span>\n    <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="axesmc" data-click="dragDialog"></span>\n    <div class="vzb-dialog-title">\n        <%=t ("buttons/axes") %>\n    </div>\n    <div class="vzb-dialog-content">\n        <div class="vzb-yaxis-container">\n            <p class="vzb-dialog-sublabel"><%=t ("hints/mount/maxYvalue") %></p>\n            <form class="vzb-dialog-paragraph">\n                <label><input type="radio" name="ymax" value="immediate"><%=t ("mount/maxYmode/immediate") %></label>\n                <label><input type="radio" name="ymax" value="latest"><%=t ("mount/maxYmode/latest") %></label>\n            </form>\n        </div>\n        <div class="vzb-xaxis-container">\n            <p class="vzb-dialog-sublabel">\n                <%=t ("hints/mount/logXstops") %>\n            </p>\n            <form class="vzb-dialog-paragraph">\n                <input type="checkbox" name="logstops" value="1">1\n                <input type="checkbox" name="logstops" value="2">2\n                <input type="checkbox" name="logstops" value="5">5\n            </form>\n        </div>\n        <p class="vzb-dialog-sublabel">\n            <%=t ("hints/mount/xlimits") %>\n        </p>\n        <div class="vzb-xlimits-container vzb-dialog-paragraph"></div>\n        <div class="vzb-probe-container">\n            <p class="vzb-dialog-sublabel">\n              <input type="checkbox" name="probe" class="vzb-probe-check"> <%=t ("hints/mount/probe") %>\n            </p>\n            <input type="text" class="vzb-probe-field" name="probe">\n        </div>\n    </div>\n    <div class="vzb-dialog-buttons">\n        <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary">\n            <%=t ("buttons/ok") %>\n        </div>\n    </div>\n</div>'},function(e,t){e.exports='\x3c!-- MountainChart Component --\x3e\n<div class="vzb-mountainchart">\n    <svg class="vzb-mountainchart-svg vzb-export">\n        <g class="vzb-mc-graph">\n            <rect class="vzb-mc-eventarea"></rect>\n            <g class="vzb-mc-year"></g>\n\n            <g class="vzb-mc-mountains-mergestacked"></g>\n            <g class="vzb-mc-mountains-mergegrouped"></g>\n            <g class="vzb-mc-mountains"></g>\n            <g class="vzb-mc-mountains-labels"></g>\n\n\n            <g class="vzb-mc-axis-y-title">\n                <text></text>\n            </g>\n\n            <g class="vzb-mc-axis-x-title">\n                <text></text>\n            </g>\n\n            <g class="vzb-mc-axis-info vzb-noexport">\n            </g>\n\n            <g class="vzb-data-warning vzb-noexport">\n                <svg></svg>\n                <text></text>\n            </g>\n\n            <g class="vzb-mc-axis-x"></g>\n\n            <g class="vzb-mc-axis-labels"></g>\n            <g class="vzb-mc-probe">\n                <text class="vzb-shadow vzb-mc-probe-value-ul"></text>\n                <text class="vzb-shadow vzb-mc-probe-value-ur"></text>\n                <text class="vzb-shadow vzb-mc-probe-value-dl"></text>\n                <text class="vzb-shadow vzb-mc-probe-value-dr"></text>\n                <text class="vzb-mc-probe-value-ul"></text>\n                <text class="vzb-mc-probe-value-ur"></text>\n                <text class="vzb-mc-probe-value-dl"></text>\n                <text class="vzb-mc-probe-value-dr"></text>\n                <text class="vzb-mc-probe-extremepoverty"></text>\n                <line></line>\n            </g>\n\n            <g class="vzb-mc-tooltip vzb-hidden">\n                <rect class="vzb-tooltip-border"></rect>\n                <text class="vzb-tooltip-text"></text>\n            </g>\n        </g>\n    </svg>\n</div>\n'},function(e,t,a){e.exports=a(0)}]);
//# sourceMappingURL=mountainchart.js.map